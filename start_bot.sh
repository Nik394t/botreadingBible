#!/bin/bash

echo "ü§ñ –ó–∞–ø—É—Å–∫ Telegram –±–æ—Ç–∞ –¥–ª—è —á—Ç–µ–Ω–∏—è –ë–∏–±–ª–∏–∏"
echo "=" * 50

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ç–æ–∫–µ–Ω–∞
if [ -z "$BOT_TOKEN" ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω BOT_TOKEN"
    echo "üìù –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:"
    echo "   1. –ù–∞–ø–∏—à–∏—Ç–µ @BotFather –≤ Telegram"
    echo "   2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /newbot"
    echo "   3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º"
    echo "   4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω"
    echo ""
    echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "   export BOT_TOKEN='–≤–∞—à_—Ç–æ–∫–µ–Ω_–∑–¥–µ—Å—å'"
    echo "   ./start_bot.sh"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ ID –≥—Ä—É–ø–ø—ã
if [ -z "$GROUP_CHAT_ID" ]; then
    echo "‚ö†Ô∏è  –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: –ù–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω GROUP_CHAT_ID"
    echo "üìù –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID –≥—Ä—É–ø–ø—ã:"
    echo "   1. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –≥—Ä—É–ø–ø—É"
    echo "   2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –ª—é–±–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É"
    echo "   3. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –ø–æ —Å—Å—ã–ª–∫–µ: https://api.telegram.org/bot<–í–ê–®_–¢–û–ö–ï–ù>/getUpdates"
    echo "   4. –ù–∞–π–¥–∏—Ç–µ chat.id –≤ –æ—Ç–≤–µ—Ç–µ"
    echo ""
    echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ ID –≥—Ä—É–ø–ø—ã –∫–æ–º–∞–Ω–¥–æ–π:"
    echo "   export GROUP_CHAT_ID='id_–≥—Ä—É–ø–ø—ã_–∑–¥–µ—Å—å'"
    echo ""
    echo "‚ñ∂Ô∏è  –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –∑–∞–ø—É—Å–∫ –±–µ–∑ –≥—Ä—É–ø–ø—ã..."
    export GROUP_CHAT_ID="YOUR_GROUP_CHAT_ID_HERE"
fi

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞
cd "/Users/sergey_andrienkobk.ru/Desktop/–ü–õ–ê–ù –ß–¢–ï–ù–ò–Ø –ë–ò–ë–õ–ò–ò/telegram_bot"

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
echo "üõë –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤..."
pkill -f "node bot.js" 2>/dev/null || true
sleep 2

# –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
cat > config.js << EOF
module.exports = {
    BOT_TOKEN: '$BOT_TOKEN',
    GROUP_CHAT_ID: '$GROUP_CHAT_ID'
};
EOF

# –û–±–Ω–æ–≤–ª—è–µ–º bot.js –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
sed -i '' "s/const BOT_TOKEN = 'YOUR_BOT_TOKEN_HERE';/const config = require('.\/config.js'); const BOT_TOKEN = config.BOT_TOKEN;/" bot.js
sed -i '' "s/const GROUP_CHAT_ID = 'YOUR_GROUP_CHAT_ID_HERE';/const GROUP_CHAT_ID = config.GROUP_CHAT_ID;/" bot.js

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
echo "üöÄ –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞..."
nohup node bot.js > bot.log 2>&1 &
BOT_PID=$!

# –ñ–¥–µ–º –∑–∞–ø—É—Å–∫–∞
sleep 3

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏–ª—Å—è
if ps -p $BOT_PID > /dev/null; then
    echo "‚úÖ –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω!"
    echo ""
    echo "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ—Ç–µ:"
    echo "   üÜî PID –ø—Ä–æ—Ü–µ—Å—Å–∞: $BOT_PID"
    echo "   üìù –õ–æ–≥–∏: bot.log"
    echo "   üóÑÔ∏è  –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: bible_bot.db"
    echo ""
    echo "üîß –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–æ—Ç–æ–º:"
    echo "   –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å: pkill -f 'node bot.js'"
    echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤: tail -f bot.log"
    echo "   –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: ./start_bot.sh"
    echo ""
    echo "üì± –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "   1. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à–µ–≥–æ –±–æ—Ç–∞ –≤ Telegram"
    echo "   2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∫–æ–º–∞–Ω–¥—É /start"
    echo "   3. –°–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –±–æ—Ç–∞"
    echo ""
    echo "üéâ –ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!"
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏
    echo ""
    echo "üìã –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏:"
    tail -10 bot.log
    
else
    echo "‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –±–æ—Ç–∞!"
    echo "üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏:"
    cat bot.log
    exit 1
fi